<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Conferência AF x FP — Corrigido</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-gray-800">Conferência AF x FP</h1>
      <p class="text-sm text-gray-600 mt-1">Agora exibindo corretamente todas as siglas (AN, AC, AD, ...).</p>
    </header>

    <div class="bg-white p-4 rounded-lg shadow mb-6">
      <div class="flex flex-col md:flex-row gap-4 items-end">
        <label class="flex flex-col">
          <span class="text-sm font-medium text-gray-700 mb-1">Arquivo AF (.CPF)</span>
          <input id="afFile" type="file" accept=".CPF" class="block"/>
        </label>

        <label class="flex flex-col">
          <span class="text-sm font-medium text-gray-700 mb-1">Arquivo FP (.CPF)</span>
          <input id="fpFile" type="file" accept=".CPF" class="block"/>
        </label>

        <div class="flex gap-2 ml-auto">
          <button id="compareBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Comparar</button>
          <button id="downloadCsvBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Baixar CSV</button>
        </div>
      </div>
    </div>

    <section id="tableWrap" class="bg-white rounded-lg shadow overflow-auto">
      <!-- tabela será injetada aqui -->
    </section>
  </div>

<script>
/* ---------- util CSV split (respeita aspas) ---------- */
function splitCSVLine(line) {
  const re = /("([^"]*(?:""[^"]*)*)"|[^,]*)(,|$)/g;
  const fields = [];
  let m;
  while ((m = re.exec(line)) !== null && m[0] !== "") {
    let val = m[1] || "";
    // remove quotes e unescape ""
    if (val.startsWith('"') && val.endsWith('"')) {
      val = val.slice(1, -1).replace(/""/g, '"');
    }
    fields.push(val);
    if (m[3] === "") break;
  }
  return fields;
}

/* ---------- converte string numérica pra centavos (inteiro) ---------- */
function toCents(raw) {
  const s = String(raw || "").trim().replace(/"/g, "");
  if (!s) return 0;
  // Expect number format like 0000055050.87 or 5564.09
  // Remove thousand separators if present (.,) — but inputs parecem usar ponto decimal.
  const clean = s.replace(/\s/g, "");
  const parts = clean.split(".");
  const intPart = parseInt((parts[0] || "0").replace(/^0+(?=\d)|^$/, ""), 10) || 0;
  const frac = (parts[1] || "00").padEnd(2, "0").slice(0,2);
  const fracPart = parseInt(frac, 10) || 0;
  return intPart * 100 + fracPart;
}

/* ---------- formata centavos pra pt-BR ---------- */
function formatCents(cents) {
  return (cents / 100).toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

/* ---------- parse AF: soma por UNIDADE+SIGLA, apenas quando col15 == "O" ---------- */
function parseAF(content) {
  const lines = content.split(/\r?\n/).filter(l => l.trim() !== "");
  const map = {}; // key: unidade-sigla => cents
  for (const rawLine of lines) {
    const cols = splitCSVLine(rawLine);
    if (cols.length === 0) continue;
    // indices: col4 -> cols[3], col5 -> cols[4], col7 -> cols[6], col14 -> cols[13], col15 -> cols[14]
    const tipo = (cols[14] || "").trim();
    if (tipo !== "O") continue;
    const unidade = ((cols[3]||"").trim()).padStart(0, ""); // keep as-is (keeps leading zeros)
    const parte = (cols[4]||"").trim();
    const uni = (unidade + parte).trim();
    const sigla = (cols[6]||"").trim();
    const valCents = toCents(cols[13]);
    const key = `${uni}-${sigla}`;
    map[key] = (map[key] || 0) + valCents;
  }
  return map;
}

/* ---------- parse FP: soma por UNIDADE+SIGLA (base) ---------- */
function parseFP(content) {
  const lines = content.split(/\r?\n/).filter(l => l.trim() !== "");
  const map = {};
  for (const rawLine of lines) {
    const cols = splitCSVLine(rawLine);
    if (cols.length === 0) continue;
    const unidade = ((cols[3]||"").trim());
    const parte = (cols[4]||"").trim();
    const uni = (unidade + parte).trim();
    const sigla = (cols[6]||"").trim();
    const valCents = toCents(cols[9]);
    const key = `${uni}-${sigla}`;
    map[key] = (map[key] || 0) + valCents;
  }
  return map;
}

/* ---------- monta tabela e controles ---------- */
function compareAndRender(afMap, fpMap) {
  // union das chaves (tudo que aparece em AF ou FP)
  const allKeys = new Set([...Object.keys(fpMap), ...Object.keys(afMap)]);
  const keys = Array.from(allKeys).sort((a,b) => {
    const [ua, sa] = a.split("-");
    const [ub, sb] = b.split("-");
    const na = parseInt(ua, 10) || 0;
    const nb = parseInt(ub, 10) || 0;
    if (na !== nb) return na - nb;
    return (sa || "").localeCompare(sb || "");
  });

  let totalAF = 0, totalFP = 0;

  let rowsHtml = keys.map(key => {
    const [unidade, sigla] = key.split("-");
    const af = afMap[key] || 0;
    const fp = fpMap[key] || 0;
    totalAF += af; totalFP += fp;
    const diff = af - fp;
    const equal = (af === fp);
    return {
      unidade,
      sigla,
      af,
      fp,
      diff,
      equal
    };
  });

  // build HTML
  const container = document.getElementById("tableWrap");
  let html = `
    <div class="p-4">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg font-semibold text-gray-800">Resultado</h2>
          <p class="text-sm text-gray-600">Base: FP — mostrando todas as combinações UNIDADE + SIGLA</p>
        </div>
        <div class="text-right text-sm text-gray-700">
          <div>Total FP: <strong>${formatCents(totalFP)}</strong></div>
          <div>Total AF: <strong>${formatCents(totalAF)}</strong></div>
          <div>Diferença total: <strong>${formatCents(totalAF - totalFP)}</strong></div>
        </div>
      </div>

      <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Unidade</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Sigla</th>
            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">FP</th>
            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">AF</th>
            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Diferença (AF - FP)</th>
            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500">Status</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-100">
  `;

  for (const r of rowsHtml) {
    html += `
      <tr class="${r.equal ? 'bg-green-50' : 'bg-red-50'} hover:bg-gray-50 transition">
        <td class="px-4 py-2 text-sm text-gray-700">${r.unidade}</td>
        <td class="px-4 py-2 text-sm text-gray-700">${r.sigla || ''}</td>
        <td class="px-4 py-2 text-sm text-right text-gray-800">${formatCents(r.fp)}</td>
        <td class="px-4 py-2 text-sm text-right text-gray-800">${formatCents(r.af)}</td>
        <td class="px-4 py-2 text-sm text-right text-gray-800">${formatCents(r.diff)}</td>
        <td class="px-4 py-2 text-sm text-center font-semibold ${r.equal ? 'text-green-700' : 'text-red-700'}">
          ${r.equal ? 'Sem diferença' : 'Diferença'}
        </td>
      </tr>
    `;
  }

  html += `
        </tbody>
      </table>
      </div>
    </div>
  `;

  container.innerHTML = html;

  // store last result for CSV download
  window._lastCompare = { rows: rowsHtml, totalAF, totalFP };
}

/* ---------- baixar CSV ---------- */
function downloadCsv() {
  const data = window._lastCompare;
  if (!data) { alert("Execute a comparação primeiro."); return; }
  const lines = [];
  lines.push(['Unidade','Sigla','FP','AF','Diferença','Status'].join(';'));
  for (const r of data.rows) {
    lines.push([
      r.unidade,
      r.sigla || '',
      formatCents(r.fp),
      formatCents(r.af),
      formatCents(r.diff),
      r.equal ? 'Sem diferença' : 'Diferença'
    ].join(';'));
  }
  const csv = lines.join("\n");
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `comparacao_af_fp_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ---------- eventos botões ---------- */
document.getElementById('compareBtn').addEventListener('click', async () => {
  const afFile = document.getElementById('afFile').files[0];
  const fpFile = document.getElementById('fpFile').files[0];
  if (!afFile || !fpFile) { alert('Selecione os dois arquivos (.CPF).'); return; }

  const [afContent, fpContent] = await Promise.all([afFile.text(), fpFile.text()]);
  const afMap = parseAF(afContent);
  const fpMap = parseFP(fpContent);
  compareAndRender(afMap, fpMap);
});

document.getElementById('downloadCsvBtn').addEventListener('click', downloadCsv);
</script>
</body>
</html>
